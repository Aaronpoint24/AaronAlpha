# ソリッド適用（確定）の永続化と整合性維持の実装計画 (改訂版)

## 変更内容の概要

### Rust コア (rust_core/src/lib.rs)

1.  **ImageContext 構造体の拡張**
    - `is_solid_applied: bool` フラグを追加。
2.  **calculate_alpha_zero の強化（パフォーマンス重視）**
    - **位置調整中の高速プレビュー (update_alignment_alpha_only) は一切変更しません。** これにより、毎フレームの移動パフォーマンスに影響を与えないことを保証します。
    - 確定時やロジック変更時に呼ばれる「重い再計算」ループ内でのみ、フラグを監視します。
    - `is_solid_applied` が真かつ `c1s_buffer[i] > 0` の場合のみ、`max(抽出α, c1sα)` を適用。
    - **RGBの再計算**: 補正後のαを用いて、入力画像から正しいストレートRGBを逆演算します。
3.  **WASM バインディングの更新**
    - apply_solid_to_alpha_zero: フラグを立てて calculate_alpha_zero を実行。
    - clear_solid_applied_flag: フラグを降ろす。

### JavaScript 側 (js/AppController.js)

1.  **リセット時のフラグ同期**
    - アプリのリセット時に `this.processor.clearSolidAppliedFlag()` を呼び出し。

---

## パフォーマンスと整合性に関する保証

> [!IMPORTANT]
> - **高速パス의保護**: update_alignment_alpha_only への追加は行わず、あくまで「確定状態（Base）」への反映に留めることで、移動中のサクサク感を維持します。
> - **非破壊的な合成**: ソリッド側が `0` の部分は計算対象外とし、元のアルファが失われない「半透明を不透明側に寄せる」一方向の補正のみを行います。
> - **忖度の排除**: 上記以外のバッファやロジックには一切触れません。

---

## 検証プラン

### 机上デバッグ
- [x] フラグ OFF 時: 回路内の if 文一つ分のオーバーヘッドのみ（無視可能）。
- [x] フラグ ON 時: 位置調整後の「確定」タイミングでソリッドが再適用される。
- [x] 0値の扱い: `if c1s > 0` により、元画像の情報を保護。
