# 認証システム：アーキテクチャ定義（Architecture）

アーロン様、ご指導ありがとうございます。
認証システムの核となる内部構造と変数・関数の役割を、既存のスタイルに合わせて定義いたしました。

---

## 1. 認証の基本仕様
本システムは「ローカル完結型の認証」を第一歩とし、将来的なオンラインアクティベーションへの互換性を保つ設計を採用します。

| 項目 | 定義・値 | 備考 |
| :--- | :--- | :--- |
| **デフォルト認証キー** | `WelcomeAaronAlpha` | 初期状態での認証コード。 |
| **ストレージキー** | `aaronAlpha_auth_key` | `localStorage` に保存される際のキー名。 |
| **認証状態の保持** | Rust(WASM)内部メモリ | JS側の改ざんを無効化するため、Rust側が「真の状態」を持つ。 |

---

## 2. Wasm（Rust）側：関数定義
難読化と堅牢性を担い、認証状態を物理的にガードします。

| 関数名 | 引数 / 戻り値 | 役割 |
| :--- | :--- | :--- |
| **`authenticate(key: &str)`** | `bool` | 渡されたキーを検証し、内部の `AUTH_STATE` を更新する。 |
| **`is_authenticated()`** | `bool` | 現在の認証状態を返す。 |
| **`get_alphaB1_buffer_ptr()`** | `*const u8` | **ガード付き取得**: `AUTH_STATE` が `false` の場合、`null` を返す。 |

---

## 3. JavaScript（AuthManager）側：管理クラス
ユーザーとの対話とログインセッションの維持を担当します。

| メソッド名 | 役割 |
| :--- | :--- |
| **`init()`** | 起動時に走る総合初期化。保存キーの有無によりダイアログを制御。 |
| **`promptUser()`** | **初回起動専用**: ブラウザの `prompt()` を呼び出し、入力を促す。 |
| **`login(key)`** | 入力キーを Rust 側に流し、成功すれば `localStorage` に永続化する。 |
| **`updateKey(key)`** | 設定画面（Settings Modal）からの手動更新用。 |

---

## 4. UI制御フラグ（AppController）
認証状態に基づき、ユーザーに使用可能な機能を視覚的に提示します。

| フラグ名 | 役割 |
| :--- | :--- |
| **`_isAuthenticated`** | コンテキスト内部で保持する認証状態。UI更新のトリガー。 |
| **`updateAuthUI(isAuth)`** | 状態に応じてヘッダーのステータス、タブ、エクスポートボタンを制御。 |

---
この定義に基づき、各モジュールが密接かつ堅牢に連携し、アーロン様の Aaron Alpha を保護いたします。
