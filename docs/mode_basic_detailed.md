# AaronAlpha モード別詳細資料：基本モード (Basic Mode)

基本モードは、画像のロード、位置合わせ、および物理モデルに基づく初期透過計算を担当する、アプリケーションの起点となるモードです。

## 1. ワークフロー概要

1.  **画像ロード**: `input_black` (黒背景画像) と `input_white` (白背景画像) をWASMメモリへ展開。
2.  **自動位置合わせ (Auto Alignment)**: `find_auto_offset` による演算。
3.  **初期計算**: `calculate_alpha_zero` による全ピクセルの透過計算。
4.  **画面表示**: `alpha_zero_buffer` をベースに背景（チェッカー/カラー）と合成して表示。

## 2. 位置合わせロジック (Auto-Alignment)

高速かつ精度の高い位置合わせを実現するため、独自の **「Ore-ore ORB」** アルゴリズムを実装しています。

### 高速化・高精度化の手順
-   **グレースケール・軽量化**: 内部で画像を1000px幅程度にリサイズし、計算量を削減。
-   **エッジ抽出 (Sobel)**: 色情報ではなく、輝度の勾配（エッジ）を用いることで、白背景と黒背景の差異を吸収。
-   **格子状FAST検知 (Grid-based FAST)**: 画像全域から均等に特徴点を抽出。
-   **バイナリ記述子 (BRIEF)**: 特徴点間の比較をビット列で行い、高速にマッチング。
-   **オフセット算出**: 最もマッチングが集中した $dX, dY$ を最終的な位置ズームに採用。

## 3. 初期透過計算 (`calculate_alpha_zero`)

アーロン様の物理モデルに基づき、2色の背景画像から透過情報（Alpha）と本来の色（RGB）を抽出します。

### ロジック解説
各ピクセル $i$ において、黒背景の色 $C_b$、白背景の色 $C_w$ としたとき：
1.  **Alphaの算出**: $A_i = 255 - \max(|C_{wi} - C_{bi}|)$ (※実際には `calc_mode` により Avg 等も選択可能)
2.  **RGB（ストレートRGB）の算出**: 
    -   $A_i > 0$ の場合: $RGB_i = \min(255, \frac{C_{bi}}{(A_i / 255)})$
    -   $A_i = 0$ の場合: $RGB_i = (0, 0, 0)$

### 留意点
-   位置合わせの $dX, dY$ が1ピクセルでもずれると、エッジ部分に計算上のノイズ（異常に明るい、または暗いピクセル）が発生します。
-   このため、位置調整中は **「スマート・リフレッシュ」** ロジック（`AppController.js`）により、入力停止後の静止時にのみ全域計算を実行しています。

## 4. 主要なフラグ・パラメータ
-   `calc_mode`: 計算アルゴリズム（Max, Avg, Lum）。通常は Max または Avg が推奨されます。
-   `offset_x / offset_y`: 現在適用されている画像間のズレ量。
-   `threshold`: ゴミ取りに渡す前の暫定的なノイズしきい値。
