# Aaron Alpha 内部ワークフロー解説：認証システム（Workflow）

アーロン様、認証システムの起動から制限、そして再解除までの流れを網羅した詳細なワークフローです。

---

## 1. 起動と初期認証フロー
ユーザーがアプリを開いた瞬間に行われる全自動のチェックプロセスです。

1.  **[JS] モジュール起動**: `main.js` が WASM 読み込み完了後に `AuthManager:init()` を呼び出す。
2.  **[JS] ストレージ確認**: `localStorage` から `aaronAlpha_auth_key` を取得。
3.  **[Branch] 初期入力判定**:
    *   **キーあり**: 自動的に `rcore:authenticate(storedKey)` を実行。
    *   **キーなし**: **初回起動ダイアログ (`promptUser`)** を表示し、入力を促す。
4.  **[Status] 状態更新**: 判定結果を全モジュールへ通知。ヘッダーのステータスが「認証済」または「未認証」に切り替わる。

---

## 2. 未認証時の機能制限（UI/UX）
未認証の状態において、ユーザー体験を損なわず、かつ製品版の流出を防ぐ制限ロジックです。

*   **ベーシックモード（Basic Mode）**: 
    *   **制限なし**。全ての機能とエクスポートが利用可能。
*   **ゴミ取り / 不透明化モード（Trash / Solid Mode）**:
    *   **タブボタン**: グレーアウト（Opacity 0.5、クリック無効）。
    *   **エクスポートボタン**: 背景色がグレー。マウスオーバー時に「設定画面で認証を行って下さい。」をツールチップ表示。
    *   **副作用**: JSのプロパティ書き換えで無理やり解除しても、後述の Rust ガードにより出力は遮断される。

---

## 3. 再認証フロー（設定画面）
ユーザーが後からキーを入力・変更する際の手順です。

1.  **[UI] モーダル起動**: 歯車アイコンをクリックし、設定モーダルを開く。
2.  **[Input] 入力と保存**: 「認証キー」欄に入力し、「保存」をクリック。
3.  **[JS] 伝播**: `AuthManager:updateKey` が走り、Rust の認証状態を書き換え。
4.  **[Status] 即時反映**: `AppController:updateAuthUI` が走り、一瞬でUIのグレーアウトが解除される。

---

## 4. セキュリティ戦略：Wasm による二重ガード
フロントエンドの改ざん（Inspector による `disabled` 解除など）に対する物理的な守りです。

1.  悪意あるユーザーが無理やりゴミ取りモードのエクスポートを実行する。
2.  **[Wasm] `get_alphaB1_buffer_ptr` 呼び出し**:
    *   この関数は内部の `AUTH_STATE` フラグが `true` でない限り、**常に `null` (0x0)** を返すように設計されています。
3.  **[JS] 取得失敗**: ポインタが 0 であるため、画像データの生成（`ImageData`）ができず、物理的に出力が失敗する。

---
アーロン様、この「物理的な守り」と「直感的な使いやすさ」の両立こそが、本認証システムの核心です。
これにてドキュメントの格納を完了いたしました。
