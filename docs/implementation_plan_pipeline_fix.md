# パイプライン正常化とソリッド消失バグの修正計画

## 1. 目的と背景
「ゴミ取りリセットでソリッドが消える」バグの原因である「処理のサイロ化」を解消する。
`alpha_zero_buffer` を唯一の絶対的な「マスターステート」として信頼し、すべての後続処理（ゴミ取り、プレビュー生成）がこのマスターからの派生として動くようにパイプラインを再統合する。

## 2. 修正方針
「ソース画像（生データ）への遡及」を限定的な場面（位置調整の再計算）のみに制限し、通常のパラメータ変更やリセット時は `alpha_zero_buffer` を起点とする。

## 3. 具体的な変更内容 (Rust/WASM)

### A. `init_trash_mode` の適正化
- `mask_buffer` (投げ縄修正) のリセット処理（255埋め）をここから削除する。
- 投げ縄のリセットは、UIからの「ゴミ取りリセット」ボタン押下時に明示的に呼ばれるようにする。

### B. `finalize_trash_matte` のマスター基準化
- `compute_pixel_raw` (生画像からの再計算) の呼び出しを完全に撤廃する。
- `alphaB1` の構築ロジックを以下のように変更：
    1. `alphaB1` に `alpha_zero_buffer` をコピー（この時点で位置合わせ・ソリッド適用を継承）。
    2. `mask_buffer` (投げ縄) とゴミ取り閾値を適用してアルファ値を加工する。

### C. `update_trash_matte_fast` の表示レイヤー別最適化
- 二値(`hard`)およびアルファ(`soft`)表示時、RGB計算をスキップしアルファ面のみを高速更新する。
- プレビュー表示時のみ、`alphaB1` のアルファ値を加工する。

### D. 位置調整「確定（Enter）」時の統合
- オフセット確定後、`calculate_alpha_zero` によって `alpha_zero_buffer` が更新された際、その最新状態が正しく `alphaB1` 等の各レイヤーへ伝播されることを確認する。

## 4. 期待される結果
- ゴミ取りのリセットを行っても、確定済みのソリッド適用結果が消失しなくなる。
- 位置調整を行っても、その後にソリッド適用結果が正しく維持される。
- `alpha_zero_buffer` が唯一の「真実」となり、バッファ間の不整合が構造的に排除される。

## 5. 検証プラン
- [ ] ソリッド適用 → ゴミ取りリセット：ソリッドが維持されているか確認。
- [ ] 位置調整確定 → ゴミ取り操作：ソリッドおよび投げ縄領域が維持されているか確認。
- [ ] 閾値スライダー操作：表示が爆速で追従し、かつソリッド部分が消えないことを確認。
