# Auto Alignment Plan V06: Refinements & Safety (Implemented)

## 概要
V05で実装された自動位置合わせ機能に対し、**精度向上（RANSAC改良）**、**ユーザー体験の改善（UIメッセージ）**、および**安全性向上（不正入力ガード）** を行うアップデートです。

---

## 1. RANSAC アルゴリズムの改良 (Rust)
### 課題
- 票数が同点（例: 20票ずつ）の場合、ソート順が不安定で、実行ごとに結果が変わる可能性があった。
- わずかなズレ（1px〜2px）で票が割れ、本来の正解が選ばれない場合があった。

### 実装内容 (`rust_core/src/lib.rs`)
1.  **近傍統合 (Neighborhood Voting)**:
    - 各オフセット候補に対し、**周囲 ±2px** の範囲にある票も自身の票として合算する。
    - これにより、「わずかにズレた票」が集約され、山がはっきりとした「強い1位」が選ばれるようになった。
2.  **距離優先ソート (Distance Priority)**:
    - 票数が同じ場合、**「原点 (0,0) からの距離が近い方」** を優先するロジックを追加。
    - さらに `x` 座標の小さい順、`y` 座標の小さい順、と評価することで、完全な決定論的動作（Determinism）を保証。

---

## 2. UI / UX の改善 (JavaScript/HTML/CSS)
### 課題
- 画像ドロップ後、計算中の数秒間画面が暗転するだけで、ユーザーは何が起きているか不安だった。
- 暗転（Loading Overlay）が消えてからメッセージが出るなど、タイミングが悪かった。

### 実装内容 (`js/AppController.js`, `index.html`, `css/styles.css`)
1.  **メッセージの最前面表示**:
    - `loading-overlay` の `z-index` を調整し、その上に **"Calculating Auto-Offset..."** というメッセージを表示するようにした。
2.  **表示タイミングの早期化**:
    - 画像ドロップ直後（`createImageBitmap` 前）からメッセージを表示し、処理完了まで出し続けるようにフローを変更。
    - ユーザーは「今計算中である」ことを明確に認識できるようになった。

---

## 3. 入力データの安全性向上 (JavaScript)
### 課題
- サイズが異なる画像を比較しようとすると、Rust側でパニックや表示崩れが発生する恐れがあった。
- PSDなどブラウザ非対応のフォーマットを投げ込むと、サイレントに失敗していた。
- エラーメッセージが英語で分かりにくかった。

### 実装内容 (`js/ImageProcessor.js`, `js/AppController.js`)
1.  **サイズ不一致の拒否**:
    - 2枚目の画像ロード時に、1枚目と `width/height` が一致するかチェック。
    - 不一致の場合、即座に例外を投げ、処理を中断する（リサイズは行わない）。
2.  **非対応フォーマットの拒否**:
    - ファイルの `mime-type` を厳密にチェック（許可: png, jpeg, webp, gif, bmp）。
    - PSD等が来たら「未対応の画像形式です」とアラートを出す。
3.  **エラーメッセージの多言語化 (i18n)**:
    - `i18n.js` を拡張し、変数埋め込み（`{{w1}}` 等）に対応。
    - 全てのエラーメッセージを日本語/英語に対応させた。

---

## 結論
本バージョンにより、自動位置合わせ機能は**「実用レベルの安定性」**と**「ユーザーフレンドリーな挙動」**を獲得しました。
不正なデータによるクラッシュも防がれており、安心して利用可能な状態です。
