# AaronAlpha 技術リファレンス：バッファ・フラグ詳細一覧

本ドキュメントは、AaronAlpha (Rust Core) 内で使用されている全バッファおよびフラグの定義、役割、ライフサイクルを網羅した詳細リファレンスです。ソースコードメンテナンスの際の辞書としてご活用ください。

## 1. 入力・キャッシュバッファ (Initial Data)

これらのバッファは画像ロード時に一度だけ生成され、通常は書き換えられません。

| バッファ名 | 型 | チャンネル | 役割・用途 |
| :--- | :--- | :---: | :--- |
| `input_black` | `Vec<u8>` | RGBA | 黒背景で撮影された元画像。全てのストレートRGB計算の物理的基準。 |
| `input_white` | `Vec<u8>` | RGBA | 白背景で撮影された元画像。位置合わせおよび初期透過計算で使用。 |

## 2. 基底・永続計算バッファ (Base & Persistence)

アプリケーションの「現在の状態」を保存し、他のモードの基準となるバッファです。

| バッファ名 | 型 | チャンネル | 役割・用途 |
| :--- | :--- | :---: | :--- |
| `alpha_zero_buffer` | `Vec<u8>` | RGBA | **システムの心臓部。** 初回計算後のRGB+Alphaを保持し、ソリッド焼付時にも更新される。 |
| `solid_burn_mask` | `Vec<u8>` | 1ch (A) | ソリッドモードで「焼付」された領域を保持。Undo時または画像破棄時まで永続する。 |

## 3. モード別ワークバッファ (Working Buffers)

各モードの計算結果や、一時的なユーザー編集を保持するためのバッファです。

| バッファ名 | 型 | チャンネル | 役割・用途 |
| :--- | :--- | :---: | :--- |
| `alphaB1` | `Vec<u8>` | RGBA | ゴミ取りモードの「製品」。ノイズ除去とガベージマット適用後の結果。 |
| `soft_mat_buffer` | `Vec<u8>` | RGBA | アルファの可視化（ソフト）用。グレースケールで透過度を表示。 |
| `hard_mat_buffer` | `Vec<u8>` | RGBA | アルファの可視化（ハード）用。2値化（しきい値128）されたマスクを表示。 |
| `mask_buffer` | `Vec<u8>` | 1ch (A) | ゴミ取りの「消しゴム/復活」用。128を基準として変動。 |
| `c1s_buffer` | `Vec<u8>` | 1ch (A) | ソリッドモードの「Live編集」用。焼付（Bake）を実行すると 0 クリアされる。 |
| `solid_buffer` | `Vec<u8>` | RGBA | ソリッドモードの閾値ベース充填結果（一時的）。 |

## 4. 表示・エクスポートバッファ (Display & Export)

最終的な描画データを格納し、JavaScript側のCanvasへ転送されるバッファです。

| バッファ名 | 型 | チャンネル | 役割・用途 |
| :--- | :--- | :---: | :--- |
| `final_buffer` | `Vec<u8>` | RGBA | 基本・ゴミ取りモードの描画用。 |
| `solid_base_buffer` | `Vec<u8>` | RGBA | ソリッドモードの統合表示（Base + Live Overlay）用。 |
| `solid_export_buffer`| `Vec<u8>` | RGBA | ソリッドモードの「書き出し用」高精度計算バッファ。 |

## 5. 主要フラグ・設定変数 (Flags & Config)

| 変数名 | 型 | 初期値 | 解説 |
| :--- | :--- | :---: | :--- |
| `calc_mode` | `u8` | `1` | アルファ計算式（`0`:Max, `1`:Avg, `2`:Lum）。 |
| `is_solid_applied` | `bool` | `false` | ソリッド焼付が一度でも実行されたかどうかの管理フラグ。|
| `gm_t, b, l, r` | `usize` | `0` | ガベージマットの矩形座標（Top, Bottom, Left, Right）。 |
| `solid_level` | `u8` | `255` | ソリッド充填時の目標不透明度レベル。 |
| `solid_ray_dist` | `u16` | `5` | レイキャスト充填の探索距離。 |

## 6. メモリ管理上の留意点
- **ポインタ参照**: 各バッファは `get_xxx_ptr()` という関数でJS側へ先頭アドレスを公開しています。
- **データサイズ**: 基本的に `width * height * 4` (RGBA) または `width * height` (1ch) です。ポインタを参照する際はこのサイズを厳守してください。
