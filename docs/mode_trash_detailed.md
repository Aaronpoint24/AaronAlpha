# AaronAlpha モード別詳細資料：ゴミ取りモード (Trash Mode)

ゴミ取りモードは、基本モードで得られた初期透過情報からノイズを除去し、エッジの透過度を精製（彫刻）するモードです。

## 1. 概念：「透過の彫刻システム」

アーロン様考案の「彫刻システム」では、半透明部分を物理的に正しく扱うために **「消しゴム（Eraser）」** と **「復活（Restorer）」** 、そして **「ガベージマット（Garbage Matte）」** を組み合わせて透過度を調整します。

## 2. ワークフローと計算バッファ

ゴミ取りの計算は主に以下のステップで行われます：

1.  **ガベージマットの適用**: `gm_t/b/l/r` 範囲外を強制的に透明 (Alpha=0) として扱う。
2.  **ノイズしきい値処理**: `threshold` 以下の微小なアルファ値を 0 に切り捨て。
3.  **ユーザー編集 (`mask_buffer`) の合成**:
    -   投げ縄ツールで描画した `mask_buffer` (1ch) の値を、計算されたアルファ値に乗算または加算。
4.  **ストレートRGBの最終精製 (`alphaB1`)**:
    -   透過度が確定した状態で、再度 `input_black` を基準にストレートRGBを確定させ、`alphaB1` に格納。

## 3. 「真のベイク・彫刻システム」 (V06新機能)

ソリッドモードでの「焼き付け（Bake）」後の修正を容易にするため、以下の高度な削除ロジックが組み込まれています。

-   **ソリッドの削り落とし**: ゴミ取りモードにおいて「投げ縄（消しゴム）」を使用すると、単に現在の表示を消すだけでなく、ソリッドモードで焼き付け（ベイク）された領域を示す `solid_burn_mask` からもその範囲を引き算します。
-   **ロジックフロー**:
    1.  投げ縄での範囲指定。
    2.  `burn_in_trash_mask` 関数（Rust）の呼び出し。
    3.  指定範囲内の `solid_burn_mask` を 0 クリア。
    4.  `calculate_alpha_zero` を再実行し、物理モデルに基づいたクリーンな状態に復帰。

## 4. 高速化の手順：Viewport Rendering

ゴミ取りモードは全ピクセルのノイズ判定を伴うため負荷が高くなりがちですが、以下の方法で高速化しています。

-   **タイル限定計算**: `AppController.js` は、現在プレビューに映っている座標範囲を `calc_viewport` としてWASMに渡し、画面外をスキップして計算します。
-   **ノイズ・ゲート**: アルファ値が一定以下（ノイズ）と判定されたピクセルは、色計算（割り算）をスキップして早期リターンします。

## 5. 主要なフラグ・バッファ
-   `mask_buffer`: 0〜255の1chバッファ。128を基準として、小さい値は「消しゴム」、大きい値は「復活」として機能します。
-   `alphaB1`: ゴミ取りが完了した「製品（Product）」としてのストレートRGB。
-   `soft_mat_buffer / hard_mat_buffer`: UI表示用の透過可視化バッファ。
