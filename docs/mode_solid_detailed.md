# AaronAlpha モード別詳細資料：ソリッドモード (Solid Mode)

ソリッドモードは、透過部分を独自のアルゴリズムで補完（充填）し、最終的な合成結果を「焼き付ける（Bake）」ことで製品クオリティへと高めるための最終工程モードです。

## 1. ワークフロー概要

1.  **動的プレビュー**: `build_solid_base_image` および `build_solid_overlay` により、編集中の透過補完イメージをリアルタイムに視覚化。
2.  **レイキャスト充填 (Solid Shot)**: `execute_solid_shot` により、指定位置から周囲へアルファを充填。
3.  **ソリッド焼付 (Bake)**: `apply_solid_to_alpha_zero` を実行し、一時的な編集内容を基底バッファへ不可逆的に統合。

## 2. 透過合成の数理モデル (物理ベース・ストレートRGB再計算)

本アプリケーションで最も物理的に正しい透過処理を行っているのが、このソリッドモードのプレビュー生成（`build_solid_preview`）です。

### アルファ拡張時のRGB再計算ロジック
通常、アルファ値を引き上げると色は濁りますが、AaronAlphaでは以下の再計算を行うことで、透過しても鮮やかな色を保ちます。

-   **条件**: ユーザー操作により Alpha が $A_{old}$ から $A_{new}$ へ引き上げられた場合 ($A_{new} > A_{old}$)。
-   **問題**: $A_{old}$ 時に計算されたストレートRGB $C_{b1}$ を $A_{new}$ の描画にそのまま使うと、割り算の比率がずれ、画面上に「白いフリンジ（縁）」が発生する。
-   **解決（アーロン理論）**: 古い $C_{b1}$ を破棄し、生の黒背景画像 $C_{black}$ を用いて $A_{new}$ を基準にRGBを逆算する。
    $$C_{output} = \frac{C_{black}}{(A_{new} / 255.0)}$$

## 3. 焼付（ベイク）システムの詳細

ソリッドモードでの「適用（焼付）」ボタンは、単なるバッファのコピーではなく、以下の複雑な工程を一括実行します。

1.  **マスクの統合**: 一時的な編集マスク `c1s_buffer` を、永久保存用の `solid_burn_mask` に加算合成。
2.  **基底バッファの更新**:
    -   `alpha_zero_buffer` (基底) のアルファ値を最新の焼き付け結果で更新。
    -   同時に、更新されたアルファ値に基づいてRGB値を物理モデルに沿って再計算し、固定。
3.  **状態のリセット**: `c1s_buffer` を 0 クリアし、次回の編集に備える。

## 4. 高速化：レイキャスト探索の最適化

`execute_solid_shot` における充填ロジックは以下の工夫で高速化されています：
-   **放射状探索**: 中心点から $N$ 方向へレイ（光線）を飛ばし、物体の輪郭 (`soft_mat_buffer`) にぶつかるまでの距離を高速プロファイリング。
-   **距離減衰フィルタ**: 輪郭付近ではアルファ値をグラデーションさせることで、アンチエイリアスの効いた自然な境界を自動生成。

## 5. 主要なフラグ・バッファ
-   `solid_burn_mask`: 焼き付け（ベイク）されたアルファ情報を保持する1chバッファ。画像のリロードや Undo 以外では破棄されません。
-   `c1s_buffer`: ユーザーが現在投げ縄等で編集している「Live」な充填用アルファ。
-   `solid_export_buffer`: 物理モデルにより精査された、最終的な書き出し用RGBAバッファ。
-   `is_solid_applied`: 焼き付けが実行されたかどうかを示す内部フラグ。
