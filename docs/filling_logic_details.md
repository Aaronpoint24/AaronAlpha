# Aaron Alpha 充填ロジック解説 (v5.2)

アーロン様、システムに実装されている「充填（Filling）」ロジックの詳細をここに記します。
現在は「ポリゴン充填」が実働しており、「レイキャスト充填」が次期実装のプレースホルダとして定義されています。

## 1. ポリゴン充填 (Polygon Fill / Lasso Tool)

ユーザーがなげなわツール（Lasso Tool）で囲んだ範囲を、Rust 側の高速計算によって塗りつぶすロジックです。

### 処理フロー
1.  **座標抽出 (JS)**: `LassoTool.js` がマウスの軌跡を座標配列として保持します。
2.  **データ転送 (JS -> WASM)**: `ImageProcessor.js` の `fillPolygon` メソッドが座標配列を `Float32Array` に平坦化し、WASM の `fill_polygon` 関数を呼び出します。
3.  **スキャンライン計算 (Rust)**:
    - Y方向の範囲を特定し、各ライン（水平走査線）とポリゴン境界の交点を算出。
    - 交点間のセグメントを対象値（255 or 0）で塗りつぶします。

### アンチエイリアス (4x AA Sampling)
`fill_polygon` は高度なアンチエイリアス機能を備えています。
- **仕組み**: 1ピクセルを縦方向に4つのサブライン（垂直オフセット: 0.125, 0.375, 0.625, 0.875）に分割して交差判定を行います。
- **カバレッジ計算**: 合計 4 回の判定のうち、何回ポリゴン内部に入ったか（0〜4）をカウント。
- **ブレンディング**: カバレッジが 4 なら不透明、1〜3 の場合は「既存値 × 反転カバレッジ + 目標値 × カバレッジ」の式でアルファブレンドを行い、滑らかなエッジを実現します。

## 2. レイキャスト充填 (Raycast Fill / 🎯 充填ボタン)

不透明な芯（Solid Core）を抽出する際、内部に生じた細かな穴や隙間を自動的に埋めるための高度なアルゴリズムです。

### アルゴリズムの意図 (Planned Logic)
- **探索距離 (`raycast_dist`)**: ユーザーがスライダーで設定した距離（pixel）を基準にします。
- **判定ロジック**:
    - 透明ピクセルから放射状（4方向または8方向）にレイを飛ばします。
    - すべての方向において、`raycast_dist` 以内に不透明ピクセル（芯）に衝突した場合、そのピクセルは「物体の内部」とみなして不透明化（充填）します。
- **メリット**: 手動でなげなわを使って塗りつぶす手間を省き、形状の連続性を自動で確保できます。

> [!NOTE]
> 現在、`execute_raycast_fill` は WASM 側でプレースホルダとして定義されており、次期アップデート（ソリッドモードの刷新）に合わせて本格実装される予定です。

## 3. マスクバッファへの統合
すべての「塗りつぶし」結果は、最終的に **`mask_buffer` (1ch Luma)** に書き込まれます。
このバッファは、ゴミ取りモードにおける消しゴム/保護、およびソリッドモードにおける芯の手動加筆の「共通の意図」として集約され、最終的な画像合成に寄与します。
